---

---

<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    <title>Comparador de Inversi√≥n</title>
    <!-- Carga de Chart.js para el gr√°fico -->
    <script
      src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"
    ></script>
    <style>
      /* Tipograf√≠a Inter */
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
      }
      /* Estilos para inputs number */
      input[type="number"] {
        -moz-appearance: textfield;
      }
      input[type="number"]::-webkit-outer-spin-button,
      input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-800">
    <div class="max-w-7xl mx-auto p-4 md:p-8">
      <h1 class="text-3xl md:text-4xl font-bold text-blue-800 mb-6 text-center">
        Comparador de Veh√≠culos de Inversi√≥n
      </h1>

      <!-- SECCI√ìN DE PAR√ÅMETROS GLOBALES -->
      <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
        <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">
          Par√°metros Globales
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-6">
          <!-- Aportaci√≥n Inicial -->
          <div class="col-span-1">
            <label
              for="inicial"
              class="block text-sm font-medium text-gray-600 mb-1"
              >Aportaci√≥n Inicial (‚Ç¨)</label
            >
            <input
              type="number"
              id="inicial"
              value="5000"
              class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg"
            />
          </div>
          <!-- Aportaci√≥n Mensual -->
          <div class="col-span-1">
            <label
              for="mensual"
              class="block text-sm font-medium text-gray-600 mb-1"
              >Aportaci√≥n Mensual (‚Ç¨)</label
            >
            <input
              type="number"
              id="mensual"
              value="200"
              class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg"
              title="Se aplicar√°n autom√°ticamente los l√≠mites legales: PIAS m√°x 8.000‚Ç¨/a√±o, Plan Pensiones m√°x 1.500‚Ç¨/a√±o"
            />
            <p class="text-xs text-gray-500 mt-1">
              <span id="limite-info" class="hidden"
                >‚ö†Ô∏è L√≠mites aplicados autom√°ticamente</span
              >
            </p>
          </div>
          <!-- Edad Actual -->
          <div class="col-span-1">
            <label
              for="edad"
              class="block text-sm font-medium text-gray-600 mb-1"
              >Edad Actual</label
            >
            <input
              type="number"
              id="edad"
              value="35"
              min="18"
              max="67"
              class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg"
              title="Tu edad actual para calcular fiscalidad correcta de PIAS"
            />
          </div>
          <!-- Horizonte de Inversi√≥n -->
          <div class="col-span-1">
            <label
              for="horizonte"
              class="block text-sm font-medium text-gray-600 mb-1"
              >Horizonte (A√±os)</label
            >
            <input
              type="number"
              id="horizonte"
              value="25"
              class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg"
            />
          </div>
          <!-- Inflaci√≥n Anual -->
          <div class="col-span-1">
            <label
              for="inflacion"
              class="block text-sm font-medium text-gray-600 mb-1"
              >Inflaci√≥n Anual (%)</label
            >
            <input
              type="number"
              step="0.1"
              id="inflacion"
              value="2"
              class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg"
            />
          </div>
          <!-- Tipo Marginal IRPF -->
          <div class="col-span-1">
            <label
              for="irpf"
              class="block text-sm font-medium text-gray-600 mb-1"
              >Tipo Marginal IRPF (%)</label
            >
            <input
              type="number"
              step="1"
              id="irpf"
              value="30"
              class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg"
              title="Tu tipo de IRPF m√°s alto. Clave para el Plan de Pensiones."
            />
          </div>
        </div>
      </div>

      <!-- SECCI√ìN DE PAR√ÅMETROS POR PRODUCTO -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
        <!-- Tarjeta: Fondo de Inversi√≥n -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
          <h3 class="text-xl font-semibold text-blue-700 mb-4">
            1. Fondo de Inversi√≥n
          </h3>
          <div class="space-y-4">
            <div>
              <label
                for="fi_rentabilidad"
                class="block text-sm font-medium text-gray-600 mb-1"
                >Rentabilidad Bruta (%)</label
              >
              <input
                type="number"
                step="0.1"
                id="fi_rentabilidad"
                value="6.0"
                class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <div>
              <label
                for="fi_gestion"
                class="block text-sm font-medium text-gray-600 mb-1"
                >Com. Gesti√≥n (%)</label
              >
              <input
                type="number"
                step="0.01"
                id="fi_gestion"
                value="1.5"
                class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <div>
              <label
                for="fi_deposito"
                class="block text-sm font-medium text-gray-600 mb-1"
                >Com. Dep√≥sito (%)</label
              >
              <input
                type="number"
                step="0.01"
                id="fi_deposito"
                value="0.15"
                class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
          </div>
        </div>

        <!-- Tarjeta: PIAS -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
          <h3 class="text-xl font-semibold text-green-700 mb-4">
            2. PIAS (Seguro de Ahorro)
          </h3>
          <div class="space-y-4">
            <div>
              <label
                for="pias_rentabilidad"
                class="block text-sm font-medium text-gray-600 mb-1"
                >Rentabilidad Bruta (%)</label
              >
              <input
                type="number"
                step="0.1"
                id="pias_rentabilidad"
                value="4.5"
                class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500"
              />
            </div>
            <div>
              <label
                for="pias_gestion"
                class="block text-sm font-medium text-gray-600 mb-1"
                >Com. Gesti√≥n / P√≥liza (%)</label
              >
              <input
                type="number"
                step="0.01"
                id="pias_gestion"
                value="1.75"
                class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500"
              />
            </div>
            <div>
              <label
                for="pias_seguro"
                class="block text-sm font-medium text-gray-600 mb-1"
                >Coste Seguro (anual ‚Ç¨)</label
              >
              <input
                type="number"
                step="1"
                id="pias_seguro"
                value="30"
                class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500"
                title="Coste fijo anual del seguro de vida asociado"
              />
            </div>
          </div>
        </div>

        <!-- Tarjeta: Plan de Pensiones -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
          <h3 class="text-xl font-semibold text-purple-700 mb-4">
            3. Plan de Pensiones
          </h3>
          <div class="space-y-4">
            <div>
              <label
                for="pp_rentabilidad"
                class="block text-sm font-medium text-gray-600 mb-1"
                >Rentabilidad Bruta (%)</label
              >
              <input
                type="number"
                step="0.1"
                id="pp_rentabilidad"
                value="5.0"
                class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-purple-500 focus:border-purple-500"
              />
            </div>
            <div>
              <label
                for="pp_gestion"
                class="block text-sm font-medium text-gray-600 mb-1"
                >Com. Gesti√≥n (%)</label
              >
              <input
                type="number"
                step="0.01"
                id="pp_gestion"
                value="1.25"
                class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-purple-500 focus:border-purple-500"
              />
            </div>
            <div>
              <label
                for="pp_deposito"
                class="block text-sm font-medium text-gray-600 mb-1"
                >Com. Dep√≥sito (%)</label
              >
              <input
                type="number"
                step="0.01"
                id="pp_deposito"
                value="0.15"
                class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-purple-500 focus:border-purple-500"
              />
            </div>
          </div>
        </div>
      </div>

      <!-- Bot√≥n de Calcular -->
      <div class="text-center mb-8">
        <button
          id="calcular"
          class="w-full md:w-auto px-12 py-4 bg-blue-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75"
        >
          Calcular Proyecci√≥n
        </button>
      </div>

      <!-- SECCI√ìN DE RESULTADOS -->
      <div
        id="resultados-container"
        class="bg-white p-6 rounded-xl shadow-lg hidden"
      >
        <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">
          Resultados de la Proyecci√≥n
        </h2>

        <!-- Gr√°fico de Comparaci√≥n (L√≠neas: Capital vs Tiempo) -->
        <div class="mb-8">
          <h3 class="text-xl font-semibold text-gray-700 mb-4">
            Evoluci√≥n del Capital Bruto (vs. Tiempo)
          </h3>
          <div class="h-80">
            <canvas id="netoChart"></canvas>
          </div>
        </div>

        <!-- Gr√°fico de Capital Neto Real -->
        <div class="mb-8">
          <h3 class="text-xl font-semibold text-gray-700 mb-4">
            Evoluci√≥n del Capital Neto Final (despu√©s de impuestos)
          </h3>
          <div class="h-80">
            <canvas id="netoRealChart"></canvas>
          </div>
        </div>

        <!-- Resumen Ejecutivo -->
        <div
          class="mb-8 p-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl border border-blue-200"
        >
          <h3 class="text-xl font-semibold text-gray-700 mb-4">
            üéØ Resumen Ejecutivo y Recomendaci√≥n
          </h3>
          <div id="resumen-ejecutivo" class="text-sm space-y-2">
            <!-- Se rellenar√° din√°micamente -->
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full min-w-max text-left">
            <thead>
              <tr class="border-b-2 border-gray-300">
                <th class="p-4 text-sm font-semibold uppercase text-gray-500"
                  >M√©trica</th
                >
                <th
                  class="p-4 text-sm font-semibold uppercase text-blue-700 text-right"
                  >Fondo Inversi√≥n</th
                >
                <th
                  class="p-4 text-sm font-semibold uppercase text-green-700 text-right"
                  >PIAS</th
                >
                <th
                  class="p-4 text-sm font-semibold uppercase text-purple-700 text-right"
                  >Plan de Pensiones</th
                >
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              <!-- Total Aportado -->
              <tr class="hover:bg-gray-50">
                <td class="p-4 font-medium">Total Aportado</td>
                <td
                  id="res_total_aportado"
                  class="p-4 font-medium text-gray-600 text-right"
                  colspan="3"></td>
              </tr>
              <!-- Capital Bruto -->
              <tr class="hover:bg-gray-50">
                <td class="p-4 font-medium"
                  >Capital Bruto (antes de impuestos)</td
                >
                <td id="res_bruto_fi" class="p-4 font-medium text-right"></td>
                <td id="res_bruto_pias" class="p-4 font-medium text-right"></td>
                <td id="res_bruto_pp" class="p-4 font-medium text-right"></td>
              </tr>
              <!-- Ahorro Fiscal -->
              <tr class="hover:bg-gray-50 bg-purple-50">
                <td class="p-4 font-medium text-purple-800"
                  >Ahorro Fiscal Acumulado (PP)</td
                >
                <td class="p-4 font-medium text-gray-400 text-right">N/A</td>
                <td class="p-4 font-medium text-gray-400 text-right">N/A</td>
                <td
                  id="res_ahorro_pp"
                  class="p-4 font-bold text-purple-800 text-right"></td>
              </tr>
              <!-- Impuestos en Rescate -->
              <tr class="hover:bg-gray-50 bg-red-50">
                <td class="p-4 font-medium text-red-800"
                  >Impuestos Estimados en Rescate</td
                >
                <td
                  id="res_impuestos_fi"
                  class="p-4 font-medium text-red-800 text-right"></td>
                <td
                  id="res_impuestos_pias"
                  class="p-4 font-medium text-red-800 text-right"></td>
                <td
                  id="res_impuestos_pp"
                  class="p-4 font-medium text-red-800 text-right"></td>
              </tr>
              <!-- CAPITAL NETO (AJUSTADO) -->
              <tr class="border-t-2 border-gray-300">
                <td class="p-4 font-bold text-lg text-gray-900"
                  >Capital Neto Final (Ajustado)</td
                >
                <td
                  id="res_neto_fi"
                  class="p-4 font-bold text-lg text-blue-800 text-right"></td>
                <td
                  id="res_neto_pias"
                  class="p-4 font-bold text-lg text-green-800 text-right"></td>
                <td
                  id="res_neto_pp"
                  class="p-4 font-bold text-lg text-purple-800 text-right"></td>
              </tr>
              <!-- CAPITAL REAL (vs Inflaci√≥n) -->
              <tr class="bg-gray-100">
                <td class="p-4 font-medium text-gray-700"
                  >Capital Neto (Poder adquisitivo hoy)</td
                >
                <td
                  id="res_real_fi"
                  class="p-4 font-medium text-gray-700 text-right"></td>
                <td
                  id="res_real_pias"
                  class="p-4 font-medium text-gray-700 text-right"></td>
                <td
                  id="res_real_pp"
                  class="p-4 font-medium text-gray-700 text-right"></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Notas Aclaratorias -->
        <div class="mt-8 pt-6 border-t border-gray-200">
          <h3 class="text-xl font-semibold text-gray-700 mb-4">
            üìã Notas sobre los C√°lculos y Fiscalidad Mejorada
          </h3>
          <div class="space-y-4 text-sm text-gray-600">
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
              <p>
                <strong class="text-blue-700"
                  >1. Fondo de Inversi√≥n (Fiscalidad Real):</strong
                >
                Se aplica el <strong>tipo escalonado real</strong> de ahorro del
                capital:
                <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                  <li>19% hasta 6.000‚Ç¨ de ganancia</li>
                  <li>21% de 6.001‚Ç¨ a 50.000‚Ç¨</li>
                  <li>23% de 50.001‚Ç¨ a 200.000‚Ç¨</li>
                  <li>26% a partir de 200.001‚Ç¨</li>
                </ul>
              </p>
            </div>

            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
              <p>
                <strong class="text-green-700"
                  >2. PIAS (Fiscalidad por Edad Correcta):</strong
                >
                La exenci√≥n fiscal depende de la <strong>edad de rescate</strong
                > al contratar renta vitalicia:
                <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                  <li><strong>Hasta 40 a√±os:</strong> 40% de exenci√≥n</li>
                  <li><strong>40-52 a√±os:</strong> 50% de exenci√≥n</li>
                  <li><strong>52-67 a√±os:</strong> 60% de exenci√≥n</li>
                  <li><strong>67+ a√±os:</strong> 75% de exenci√≥n</li>
                </ul>
                <p class="mt-2 text-xs">
                  Solo las ganancias no exentas tributan al 19% (primer tramo de
                  ahorro).
                </p>
              </p>
            </div>

            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
              <p>
                <strong class="text-purple-700"
                  >3. Plan de Pensiones + L√≠mites Legales:</strong
                >
                <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                  <li>
                    <strong>L√≠mite m√°ximo:</strong> 1.500‚Ç¨/a√±o (aplicado autom√°ticamente)
                  </li>
                  <li>
                    <strong>Ventaja:</strong> Reducci√≥n inmediata en IRPF por cada
                    aportaci√≥n
                  </li>
                  <li>
                    <strong>Desventaja:</strong> TODO el capital rescatado tributa
                    como rendimiento del trabajo
                  </li>
                  <li>
                    <strong>C√°lculo neto:</strong> (Capital - Impuestos rescate)
                    + Ahorro fiscal acumulado
                  </li>
                </ul>
              </p>
            </div>

            <div class="bg-amber-50 p-4 rounded-lg border border-amber-200">
              <p>
                <strong class="text-amber-700"
                  >4. L√≠mites Autom√°ticos Aplicados:</strong
                >
                <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                  <li><strong>PIAS:</strong> M√°ximo 8.000‚Ç¨/a√±o</li>
                  <li><strong>Plan de Pensiones:</strong> M√°ximo 1.500‚Ç¨/a√±o</li>
                  <li>
                    El simulador ajusta autom√°ticamente las aportaciones si
                    exceden estos l√≠mites
                  </li>
                </ul>
              </p>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
              <p>
                <strong class="text-gray-700">5. Nuevas Funcionalidades:</strong
                >
                <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                  <li><strong>Fiscalidad real</strong> seg√∫n tramos y edad</li>
                  <li>
                    <strong>L√≠mites legales</strong> aplicados autom√°ticamente
                  </li>
                  <li>
                    <strong>Doble gr√°fico:</strong> Capital bruto vs Capital neto
                    final
                  </li>
                  <li>
                    <strong>Resumen ejecutivo</strong> con recomendaci√≥n autom√°tica
                  </li>
                  <li>
                    <strong>Alertas inteligentes</strong> sobre l√≠mites y exenciones
                  </li>
                </ul>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script is:inline>
      // Variables globales para los gr√°ficos
      let netoChart = null;
      let netoRealChart = null;

      /**
       * Calcula el tipo de gravamen de ahorro seg√∫n la ganancia acumulada
       * @param {number} ganancia Ganancia total de capital
       * @returns {number} Tipo de gravamen aplicable
       */
      function calcularTipoAhorro(ganancia) {
        if (ganancia <= 6000) return 0.19;
        if (ganancia <= 50000) return 0.21;
        if (ganancia <= 200000) return 0.23;
        return 0.26;
      }

      /**
       * Calcula el impuesto escalonado sobre ganancias de capital
       * @param {number} ganancia Ganancia total
       * @returns {number} Impuesto total a pagar
       */
      function calcularImpuestoEscalonado(ganancia) {
        if (ganancia <= 0) return 0;

        let impuesto = 0;
        let restante = ganancia;

        // Tramo 1: hasta 6.000‚Ç¨ al 19%
        const tramo1 = Math.min(restante, 6000);
        impuesto += tramo1 * 0.19;
        restante -= tramo1;

        if (restante <= 0) return impuesto;

        // Tramo 2: de 6.001‚Ç¨ a 50.000‚Ç¨ al 21%
        const tramo2 = Math.min(restante, 44000);
        impuesto += tramo2 * 0.21;
        restante -= tramo2;

        if (restante <= 0) return impuesto;

        // Tramo 3: de 50.001‚Ç¨ a 200.000‚Ç¨ al 23%
        const tramo3 = Math.min(restante, 150000);
        impuesto += tramo3 * 0.23;
        restante -= tramo3;

        if (restante <= 0) return impuesto;

        // Tramo 4: m√°s de 200.000‚Ç¨ al 26%
        impuesto += restante * 0.26;

        return impuesto;
      }

      /**
       * Calcula el porcentaje de exenci√≥n de PIAS seg√∫n la edad de rescate
       * @param {number} edadRescate Edad cuando se rescata el PIAS
       * @returns {number} Porcentaje de exenci√≥n (0-1)
       */
      function calcularExencionPIAS(edadRescate) {
        if (edadRescate < 40) return 0.4;
        if (edadRescate < 52) return 0.5;
        if (edadRescate < 67) return 0.6;
        return 0.75; // 67+ a√±os
      }

      /**
       * Aplica l√≠mites legales a las aportaciones
       * @param {number} aportacionAnual Aportaci√≥n anual deseada
       * @param {string} producto Tipo de producto ('pias' o 'pp')
       * @returns {number} Aportaci√≥n limitada
       */
      function aplicarLimites(aportacionAnual, producto) {
        const limites = {
          pias: 8000,
          pp: 1500,
        };
        return Math.min(aportacionAnual, limites[producto] || aportacionAnual);
      }

      /**
       * Inicializa o actualiza el gr√°fico de l√≠neas con la evoluci√≥n anual del capital bruto.
       */
      function actualizarGrafico(
        years,
        capital_fi_anual,
        capital_pias_anual,
        capital_pp_anual
      ) {
        const ctx = document.getElementById("netoChart").getContext("2d");

        const data = {
          labels: years,
          datasets: [
            {
              label: "Fondo de Inversi√≥n (Bruto)",
              data: capital_fi_anual,
              borderColor: "rgb(37, 99, 235)",
              backgroundColor: "rgba(37, 99, 235, 0.1)",
              tension: 0.3,
              pointRadius: 2,
              fill: false,
            },
            {
              label: "PIAS (Bruto)",
              data: capital_pias_anual,
              borderColor: "rgb(22, 163, 74)",
              backgroundColor: "rgba(22, 163, 74, 0.1)",
              tension: 0.3,
              pointRadius: 2,
              fill: false,
            },
            {
              label: "Plan de Pensiones (Bruto)",
              data: capital_pp_anual,
              borderColor: "rgb(126, 34, 206)",
              backgroundColor: "rgba(126, 34, 206, 0.1)",
              tension: 0.3,
              pointRadius: 2,
              fill: false,
            },
          ],
        };

        const options = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: "top",
              labels: {
                usePointStyle: true,
                font: { size: 12 },
              },
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  let label = context.dataset.label || "";
                  if (label) {
                    label += ": ";
                  }
                  label += new Intl.NumberFormat("es-ES", {
                    style: "currency",
                    currency: "EUR",
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0,
                  }).format(context.raw);
                  return label;
                },
              },
            },
          },
          scales: {
            x: {
              title: {
                display: true,
                text: "Tiempo (A√±os)",
              },
              grid: {
                display: false,
              },
            },
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: "Capital Bruto Acumulado (‚Ç¨)",
              },
              ticks: {
                callback: function (value) {
                  return new Intl.NumberFormat("es-ES", {
                    style: "currency",
                    currency: "EUR",
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0,
                  }).format(value);
                },
              },
            },
          },
        };

        if (netoChart) {
          netoChart.destroy();
        }
        netoChart = new Chart(ctx, {
          type: "line",
          data: data,
          options: options,
        });
      }

      /**
       * Actualiza el gr√°fico de capital neto real
       */
      function actualizarGraficoNeto(
        years,
        neto_fi_anual,
        neto_pias_anual,
        neto_pp_anual
      ) {
        const ctx = document.getElementById("netoRealChart").getContext("2d");

        const data = {
          labels: years,
          datasets: [
            {
              label: "Fondo de Inversi√≥n (Neto)",
              data: neto_fi_anual,
              borderColor: "rgb(37, 99, 235)",
              backgroundColor: "rgba(37, 99, 235, 0.2)",
              tension: 0.3,
              pointRadius: 3,
              fill: false,
              borderWidth: 3,
            },
            {
              label: "PIAS (Neto)",
              data: neto_pias_anual,
              borderColor: "rgb(22, 163, 74)",
              backgroundColor: "rgba(22, 163, 74, 0.2)",
              tension: 0.3,
              pointRadius: 3,
              fill: false,
              borderWidth: 3,
            },
            {
              label: "Plan de Pensiones (Neto + Ahorro)",
              data: neto_pp_anual,
              borderColor: "rgb(126, 34, 206)",
              backgroundColor: "rgba(126, 34, 206, 0.2)",
              tension: 0.3,
              pointRadius: 3,
              fill: false,
              borderWidth: 3,
            },
          ],
        };

        const options = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: "top",
              labels: {
                usePointStyle: true,
                font: { size: 12 },
              },
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  let label = context.dataset.label || "";
                  if (label) {
                    label += ": ";
                  }
                  label += new Intl.NumberFormat("es-ES", {
                    style: "currency",
                    currency: "EUR",
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0,
                  }).format(context.raw);
                  return label;
                },
              },
            },
          },
          scales: {
            x: {
              title: {
                display: true,
                text: "Tiempo (A√±os)",
              },
              grid: {
                display: false,
              },
            },
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: "Capital Neto Final (‚Ç¨)",
              },
              ticks: {
                callback: function (value) {
                  return new Intl.NumberFormat("es-ES", {
                    style: "currency",
                    currency: "EUR",
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0,
                  }).format(value);
                },
              },
            },
          },
        };

        if (netoRealChart) {
          netoRealChart.destroy();
        }
        netoRealChart = new Chart(ctx, {
          type: "line",
          data: data,
          options: options,
        });
      }

      /**
       * Genera el resumen ejecutivo con recomendaciones
       */
      function generarResumenEjecutivo(resultados) {
        const {
          neto_fi,
          neto_pias,
          neto_pp_ajustado,
          totalAportado,
          edadRescate,
          limitesAplicados,
        } = resultados;

        // Determinar el mejor producto
        let mejor = {
          nombre: "Fondo de Inversi√≥n",
          valor: neto_fi,
          color: "blue",
        };
        if (neto_pias > mejor.valor) {
          mejor = { nombre: "PIAS", valor: neto_pias, color: "green" };
        }
        if (neto_pp_ajustado > mejor.valor) {
          mejor = {
            nombre: "Plan de Pensiones",
            valor: neto_pp_ajustado,
            color: "purple",
          };
        }

        const diferencia =
          mejor.valor - Math.min(neto_fi, neto_pias, neto_pp_ajustado);
        const rentabilidadTotal =
          ((mejor.valor - totalAportado) / totalAportado) * 100;

        let html = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded-lg border border-${mejor.color}-200">
              <h4 class="font-semibold text-${mejor.color}-800 mb-2">üèÜ Mejor Opci√≥n</h4>
              <p class="text-sm"><strong>${mejor.nombre}</strong></p>
              <p class="text-lg font-bold text-${mejor.color}-700">${new Intl.NumberFormat("es-ES", { style: "currency", currency: "EUR" }).format(mejor.valor)}</p>
              <p class="text-xs text-gray-600">Ventaja: +${new Intl.NumberFormat("es-ES", { style: "currency", currency: "EUR" }).format(diferencia)}</p>
            </div>
            <div class="bg-white p-4 rounded-lg border border-gray-200">
              <h4 class="font-semibold text-gray-800 mb-2">üìä Rentabilidad Total</h4>
              <p class="text-lg font-bold text-gray-700">${rentabilidadTotal.toFixed(1)}%</p>
              <p class="text-xs text-gray-600">Sobre inversi√≥n total</p>
            </div>
          </div>
        `;

        // A√±adir alertas importantes
        html += `<div class="mt-4 space-y-2">`;

        if (limitesAplicados.pias || limitesAplicados.pp) {
          html += `<div class="flex items-center text-amber-700 bg-amber-50 p-2 rounded">
            <span class="mr-2">‚ö†Ô∏è</span>
            <span class="text-sm">Se han aplicado l√≠mites legales autom√°ticamente.</span>
          </div>`;
        }

        if (edadRescate < 67) {
          const exencion = calcularExencionPIAS(edadRescate) * 100;
          html += `<div class="flex items-center text-blue-700 bg-blue-50 p-2 rounded">
            <span class="mr-2">‚ÑπÔ∏è</span>
            <span class="text-sm">PIAS: Exenci√≥n del ${exencion}% a los ${edadRescate} a√±os. Mejora con la edad.</span>
          </div>`;
        }

        html += `</div>`;

        document.getElementById("resumen-ejecutivo").innerHTML = html;
      }

      document.addEventListener("DOMContentLoaded", function () {
        document
          .getElementById("calcular")
          .addEventListener("click", function () {
            // --- 1. LEER DATOS GLOBALES ---
            const inicial =
              parseFloat(document.getElementById("inicial").value) || 0;
            const mensual =
              parseFloat(document.getElementById("mensual").value) || 0;
            const horizonte =
              parseInt(document.getElementById("horizonte").value) || 0;
            const inflacion =
              parseFloat(document.getElementById("inflacion").value) / 100 || 0;
            const irpf =
              parseFloat(document.getElementById("irpf").value) / 100 || 0;
            const edadActual =
              parseInt(document.getElementById("edad").value) || 35;
            const edadRescate = edadActual + horizonte;

            // --- 2. LEER COMISIONES Y RENTABILIDAD POR PRODUCTO ---
            // Fondo de Inversi√≥n
            const fi_rentabilidad_anual =
              parseFloat(document.getElementById("fi_rentabilidad").value) /
                100 || 0;
            const fi_gestion =
              parseFloat(document.getElementById("fi_gestion").value) / 100 ||
              0;
            const fi_deposito =
              parseFloat(document.getElementById("fi_deposito").value) / 100 ||
              0;
            const comision_fi_total = fi_gestion + fi_deposito;
            const fi_rentabilidadMensual =
              Math.pow(1 + fi_rentabilidad_anual, 1 / 12) - 1;

            // PIAS
            const pias_rentabilidad_anual =
              parseFloat(document.getElementById("pias_rentabilidad").value) /
                100 || 0;
            const pias_gestion =
              parseFloat(document.getElementById("pias_gestion").value) / 100 ||
              0;
            const pias_seguro =
              parseFloat(document.getElementById("pias_seguro").value) || 0;
            const pias_rentabilidadMensual =
              Math.pow(1 + pias_rentabilidad_anual, 1 / 12) - 1;

            // Plan de Pensiones
            const pp_rentabilidad_anual =
              parseFloat(document.getElementById("pp_rentabilidad").value) /
                100 || 0;
            const pp_gestion =
              parseFloat(document.getElementById("pp_gestion").value) / 100 ||
              0;
            const pp_deposito =
              parseFloat(document.getElementById("pp_deposito").value) / 100 ||
              0;
            const comision_pp_total = pp_gestion + pp_deposito;
            const pp_rentabilidadMensual =
              Math.pow(1 + pp_rentabilidad_anual, 1 / 12) - 1;

            // --- 3. APLICAR L√çMITES Y VALIDACIONES ---
            const aportacionAnual = mensual * 12;
            const limitePIAS = aplicarLimites(aportacionAnual, "pias");
            const limitePP = aplicarLimites(aportacionAnual, "pp");

            const limitesAplicados = {
              pias: limitePIAS < aportacionAnual,
              pp: limitePP < aportacionAnual,
            };

            // Mostrar alerta si se aplican l√≠mites
            const limiteInfo = document.getElementById("limite-info");
            if (limitesAplicados.pias || limitesAplicados.pp) {
              limiteInfo.classList.remove("hidden");
            } else {
              limiteInfo.classList.add("hidden");
            }

            // --- 4. INICIALIZAR VARIABLES DE C√ÅLCULO ---
            let capital_fi = inicial;
            let capital_pias = inicial;
            let capital_pp = inicial;

            let totalAportado = inicial;
            let ahorroFiscalPP = 0;

            // Arrays para los gr√°ficos
            let capital_fi_anual = [inicial];
            let capital_pias_anual = [inicial];
            let capital_pp_anual = [inicial];
            let neto_fi_anual = [inicial];
            let neto_pias_anual = [inicial];
            let neto_pp_anual = [inicial];
            let years = [0];

            // --- 5. BUCLE DE SIMULACI√ìN ANUAL ---
            for (let ano = 0; ano < horizonte; ano++) {
              // Calcular aportaciones con l√≠mites
              const aportacion_fi = mensual * 12;
              const aportacion_pias = Math.min(mensual * 12, limitePIAS);
              const aportacion_pp = Math.min(mensual * 12, limitePP);

              // Actualizar total aportado (usar el m√≠nimo para c√°lculo justo)
              totalAportado += Math.min(
                aportacion_fi,
                aportacion_pias,
                aportacion_pp
              );

              // Ahorro fiscal del PP
              ahorroFiscalPP += aportacion_pp * irpf;

              // Simulaci√≥n mensual
              for (let mes = 0; mes < 12; mes++) {
                const aportacion_mensual_fi = aportacion_fi / 12;
                const aportacion_mensual_pias = aportacion_pias / 12;
                const aportacion_mensual_pp = aportacion_pp / 12;

                // Aplicar aportaciones y rentabilidad mensual
                capital_fi =
                  (capital_fi + aportacion_mensual_fi) *
                  (1 + fi_rentabilidadMensual);
                capital_pias =
                  (capital_pias + aportacion_mensual_pias) *
                  (1 + pias_rentabilidadMensual);
                capital_pp =
                  (capital_pp + aportacion_mensual_pp) *
                  (1 + pp_rentabilidadMensual);
              }

              // Aplicar comisiones anuales
              capital_fi *= 1 - comision_fi_total;
              capital_pias = capital_pias * (1 - pias_gestion) - pias_seguro;
              capital_pp *= 1 - comision_pp_total;

              // Guardar datos anuales
              capital_fi_anual.push(capital_fi);
              capital_pias_anual.push(capital_pias);
              capital_pp_anual.push(capital_pp);

              // Calcular netos aproximados para el gr√°fico
              const ganancias_fi_temp = capital_fi - totalAportado;
              const impuestos_fi_temp =
                calcularImpuestoEscalonado(ganancias_fi_temp);
              const exencion_pias = calcularExencionPIAS(edadRescate);
              const ganancias_pias = capital_pias - totalAportado;
              const impuestos_pias_temp =
                ganancias_pias * (1 - exencion_pias) * 0.19; // M√≠nimo de ahorro
              const impuestos_pp_temp = capital_pp * irpf;

              neto_fi_anual.push(capital_fi - impuestos_fi_temp);
              neto_pias_anual.push(
                capital_pias - Math.max(0, impuestos_pias_temp)
              );
              neto_pp_anual.push(
                capital_pp - impuestos_pp_temp + ahorroFiscalPP
              );

              years.push(ano + 1);
            }

            // --- 6. C√ÅLCULO DE IMPUESTOS Y NETO FINAL ---
            // Fondo de Inversi√≥n - Impuesto escalonado
            const ganancias_fi = capital_fi - totalAportado;
            const impuestos_fi = calcularImpuestoEscalonado(ganancias_fi);
            const neto_fi = capital_fi - impuestos_fi;

            // PIAS - Exenci√≥n por edad
            const exencionPIAS = calcularExencionPIAS(edadRescate);
            const ganancias_pias = capital_pias - totalAportado;
            const impuestos_pias = Math.max(
              0,
              ganancias_pias * (1 - exencionPIAS) * 0.19
            );
            const neto_pias = capital_pias - impuestos_pias;

            // Plan de Pensiones
            const impuestos_pp = capital_pp * irpf;
            const neto_pp_bruto = capital_pp - impuestos_pp;
            const neto_pp_ajustado = neto_pp_bruto + ahorroFiscalPP;

            // Capital real (ajustado a inflaci√≥n)
            const factorInflacion = Math.pow(1 + inflacion, horizonte);
            const real_fi = neto_fi / factorInflacion;
            const real_pias = neto_pias / factorInflacion;
            const real_pp = neto_pp_ajustado / factorInflacion;

            // --- 7. MOSTRAR RESULTADOS ---
            const formatter = new Intl.NumberFormat("es-ES", {
              style: "currency",
              currency: "EUR",
            });

            document.getElementById("res_total_aportado").textContent =
              formatter.format(totalAportado);
            document.getElementById("res_bruto_fi").textContent =
              formatter.format(capital_fi);
            document.getElementById("res_bruto_pias").textContent =
              formatter.format(capital_pias);
            document.getElementById("res_bruto_pp").textContent =
              formatter.format(capital_pp);
            document.getElementById("res_ahorro_pp").textContent =
              `+${formatter.format(ahorroFiscalPP)}`;
            document.getElementById("res_impuestos_fi").textContent =
              `-${formatter.format(impuestos_fi)}`;
            document.getElementById("res_impuestos_pias").textContent =
              impuestos_pias > 0
                ? `-${formatter.format(impuestos_pias)} (${Math.round(exencionPIAS * 100)}% exento)`
                : formatter.format(0) +
                  ` (${Math.round(exencionPIAS * 100)}% exento)`;
            document.getElementById("res_impuestos_pp").textContent =
              `-${formatter.format(impuestos_pp)}`;
            document.getElementById("res_neto_fi").textContent =
              formatter.format(neto_fi);
            document.getElementById("res_neto_pias").textContent =
              formatter.format(neto_pias);
            document.getElementById("res_neto_pp").textContent =
              formatter.format(neto_pp_ajustado);
            document.getElementById("res_real_fi").textContent =
              formatter.format(real_fi);
            document.getElementById("res_real_pias").textContent =
              formatter.format(real_pias);
            document.getElementById("res_real_pp").textContent =
              formatter.format(real_pp);

            // --- 8. ACTUALIZAR GR√ÅFICOS ---
            actualizarGrafico(
              years,
              capital_fi_anual,
              capital_pias_anual,
              capital_pp_anual
            );
            actualizarGraficoNeto(
              years,
              neto_fi_anual,
              neto_pias_anual,
              neto_pp_anual
            );

            // --- 9. GENERAR RESUMEN EJECUTIVO ---
            generarResumenEjecutivo({
              neto_fi,
              neto_pias,
              neto_pp_ajustado,
              totalAportado,
              edadRescate,
              limitesAplicados,
            });

            // Mostrar resultados
            document
              .getElementById("resultados-container")
              .classList.remove("hidden");
          });
      });
    </script>
  </body>
</html>
